#
# examples.py
#
# Demonstrate maxarcat Catalog's search and query methods.
#

import argparse
import logging
import sys
from datetime import datetime

from maxarcat import Catalog

logging.basicConfig(level=logging.INFO, stream=sys.stdout)


class Examples:
    def __init__(self, token):
        self.catalog = Catalog(token=token)

    def search_example(self):
        """
        Call search method and page until all items returned.
        """
        limit = 1000
        page = 0
        while True:
            page += 1
            print(f'Querying page {page}')
            result = self.catalog.search(
                collections=['imagery'],
                start_datetime=datetime(2023, 8, 1),
                end_datetime=datetime(2023, 8, 2),
                page=page,
                limit=limit)
            print(f'Feature count: {len(result.features)}')
            # Stop page requests if there is no "next" link
            if result.links is None or not any([link['rel'] == 'next' for link in result.links]):
                break

    def query_example(self):
        """
        Call query method and let it perform paging
        """

        # Ukraine test for Skander 20230919
        result = self.catalog.query(
            collections=['wv01', 'wv02', 'wv03-vnir'],
            where="raw_archive_state = 'online'",
            intersects={
                "type":        "Polygon",
                "coordinates": [[[35.83935306029832, 44.968120340374696], [35.91359224368006, 45.00048101005393],
                                 [35.95832611058984, 44.98715602842134], [36.03656278846154, 45.02617918891684],
                                 [36.22596788452552, 45.009047069675034], [36.28878565507955, 45.034745248537945],
                                 [36.38110874210571, 45.03855238614722], [36.48294967315519, 45.09756301909175],
                                 [36.43821580624564, 45.13373082638043], [36.43060153102692, 45.211777147371606],
                                 [36.47723896674131, 45.28887168396062], [36.55338171892788, 45.22986105101603],
                                 [36.61048878306781, 45.23937889503935], [36.59050131061878, 45.3212323536398],
                                 [36.67425833802406, 45.3754840645729], [36.61634225714215, 45.45045889798229],
                                 [36.53815316849051, 45.44877146355242], [36.43155331542937, 45.48303570203626],
                                 [36.32128909241919, 45.49209946558432], [36.16067547452565, 45.49923784860181],
                                 [36.05240999876037, 45.45878701150269], [36.03456404121664, 45.40286967786568],
                                 [35.96555967204756, 45.40524913887151], [35.90726287740472, 45.42547455742107],
                                 [35.885847728352246, 45.44688970647354], [35.90369368589597, 45.48496108256683],
                                 [35.83309632480916, 45.481873395955915], [35.77877198308988, 45.443320514964796],
                                 [35.74545952900826, 45.41119779138609], [35.721664918949955, 45.36360857126948],
                                 [35.67407569883335, 45.348142074731584], [35.53844642150102, 45.30769123763247],
                                 [35.52357479021458, 45.35361483504499], [35.10716911419428, 45.95799793052589],
                                 [35.709172748669346, 46.18404672607977], [35.96948578270724, 46.23401540720221],
                                 [36.45013690588496, 46.40057767761033], [36.659087067441476, 46.4443221579337],
                                 [36.76140389069218, 46.45621946296285], [36.84512743285279, 46.49337665683771],
                                 [36.952203178114985, 46.5552426429893], [37.04262269633654, 46.57189887003011],
                                 [37.418577535257725, 46.65755946624], [37.720769082998174, 46.762255750496536],
                                 [37.958715183581205, 46.838398502683106], [38.2252148162342, 46.95737155297462],
                                 [38.36270992575163, 47.273192303768155], [38.3184519510433, 47.375985019220025],
                                 [38.359854572544805, 47.53160176900121], [38.51505172665509, 47.58148656853683],
                                 [38.79957896642219, 47.67294175274765], [38.9009440052705, 47.827130825925394],
                                 [39.326391633112905, 47.814281736493854], [39.783248146232324, 47.80600121219362],
                                 [39.87890247866676, 48.02158037932179], [40.03451922844812, 48.215744397397486],
                                 [40.04308528806905, 48.24858095927806], [39.987405900532735, 48.33566923209139],
                                 [39.987405900532735, 48.358512057747305], [39.87461944885632, 48.57766041638439],
                                 [39.72756875869601, 48.637622833731314], [39.821390744189955, 48.78154773091052],
                                 [39.966448297747434, 48.74184440868436], [40.097336999001925, 48.79895028992661],
                                 [40.097336999001925, 48.90174300537848], [39.78753117604299, 49.005963397433845],
                                 [39.95885236846277, 49.017384810261774], [40.23011092312743, 49.22411238244831],
                                 [40.29292869368123, 49.30548994884771], [40.12017982465801, 49.46253437523251],
                                 [40.19013597822931, 49.52963517559681], [40.1730038589875, 49.6267171846348],
                                 [39.823223091130444, 49.62528950803119], [39.60421750015382, 49.769770380305204],
                                 [39.31297147304008, 49.788330176150794], [39.18448057872524, 49.90825501084453],
                                 [38.93406610247166, 49.87113541915363], [38.69564410968758, 50.02960752214187],
                                 [38.504335444818764, 50.02246913912438], [38.328731222588544, 50.10812973533427],
                                 [38.18425035031436, 50.103846705523836], [38.13999237560603, 50.0081923730894],
                                 [38.05147642618908, 49.959651368570576], [37.927268561684684, 50.0867145862818],
                                 [37.70169565833203, 50.18665194852667], [37.66314839003752, 50.34084102170448],
                                 [37.46698562471698, 50.48717787356304], [37.15717980175782, 50.38866818792155],
                                 [36.89877033652476, 50.390095864525165], [36.65320996072302, 50.26731567662421],
                                 [36.467326466947554, 50.35725930264476], [36.087564490417094, 50.48289484375255],
                                 [35.813165047224686, 50.450058281872145], [35.66040365065032, 50.378674451697236],
                                 [35.643271531408345, 50.42436010300901], [35.43625842390111, 50.58425988260086],
                                 [35.52905740312849, 50.68848027465617], [35.42912004088362, 50.932612973854475],
                                 [35.3648745937262, 50.95117276969995], [35.4433968069186, 51.04796924341707],
                                 [35.316333589207375, 51.09651024793607], [35.18690695683017, 51.08297816244641],
                                 [35.173565928857556, 51.24070558488933], [34.99510635342028, 51.2492716445102],
                                 [34.79665930553392, 51.226428818854345], [34.51597808528618, 51.30209567883969],
                                 [34.34037386305596, 51.29210194261515], [34.403191633609936, 51.38632859844614],
                                 [34.27238318602531, 51.41466406005645], [34.32181406721054, 51.52338555238191],
                                 [34.161914287618686, 51.664011697826595], [34.44744960831832, 51.71540805555247],
                                 [34.44602193171488, 51.826766830625274], [34.04484480613178, 52.22794395620838],
                                 [33.84497008164203, 52.38641605919662], [33.191950803202076, 52.39926514862816],
                                 [32.89499406967434, 52.28662146461215], [32.63801228104467, 52.318030349889],
                                 [32.590898953129226, 52.33659014573459], [32.36389837317313, 52.35800529478706],
                                 [32.323923428275066, 52.288049141215595], [32.2982252494121, 52.15527521709032],
                                 [32.08407375888737, 52.09816815295039], [31.414493431846836, 52.15955824690076],
                                 [31.26887041829002, 52.08817441672585], [31.107542962094726, 52.12101097860625],
                                 [30.95335388891698, 52.09816815295039], [30.71778724933978, 51.89829342846065],
                                 [30.472226873538034, 51.66629598039219], [30.592151708231768, 51.339358038190994],
                                 [30.515111258212357, 51.2921369155826], [30.329459213188215, 51.45785519628134],
                                 [30.1844072702728, 51.536377409473744], [29.94170224767811, 51.50925155400739],
                                 [29.730691645681134, 51.550654175508726], [29.647886402678125, 51.53209437966325],
                                 [29.53367227439827, 51.50639620080034], [29.47228218044785, 51.43358469402199],
                                 [29.35664037556461, 51.46356590269539], [29.163904034092354, 51.68200042303056],
                                 [29.020812810083612, 51.63409676898675], [28.921199011497663, 51.61061659285565],
                                 [28.747022465870828, 51.56064791173321], [28.50717279648319, 51.61061659285565],
                                 [28.374398872357858, 51.58777376719979], [28.268750803698936, 51.699132542272594],
                                 [28.064593049398752, 51.61918265247675], [27.813321967182958, 51.64345315473611],
                                 [27.795135015382016, 51.5796054271554], [27.76192560945708, 51.523528320042374],
                                 [27.7476488434221, 51.616327299269756], [27.482100995171493, 51.65630224416765],
                                 [27.30222239663999, 51.652894836641906], [27.223826427882273, 51.78661853466264],
                                 [26.97416538579364, 51.79358128113074], [26.88755300518136, 51.76693131786544],
                                 [26.75144783564781, 51.82403838200537], [26.61716490038765, 51.8557736079286],
                                 [26.53919991392769, 51.817375891189045], [26.453539317717798, 51.862109758098654],
                                 [26.405291841876647, 51.88893535791334], [26.353401570590393, 51.8900741611169],
                                 [26.207027157513892, 51.8811454461453], [26.079342721547334, 51.925713573674784],
                                 [26.024578080943797, 51.94604242205327], [25.824647773876904, 51.95883484798554],
                                 [25.239593895120265, 51.98887272015821], [25.176538178465762, 51.99006245066113],
                                 [24.950830377169268, 51.93184382864274], [24.396106632879878, 51.935079895610784],
                                 [24.362199313546796, 51.922587725330175], [24.333645781476832, 51.89403419326021],
                                 [24.255551871265595, 51.7705163724475], [24.245558135041108, 51.73054142754961],
                                 [24.1260871871512, 51.690322573088], [23.995714729428926, 51.60633356304521],
                                 [23.931469282271507, 51.647736184546716], [23.801657460102774, 51.69368396954076],
                                 [23.73974030777856, 51.702821849574036], [23.64218240653952, 51.690924544544885],
                                 [23.54256517942798, 51.62168790814371], [23.543857148922427, 51.49111285791753],
                                 [23.611249413463725, 51.452978443961854], [23.592213725417082, 51.2840367125479],
                                 [23.79446791091266, 51.1031976761048], [23.95389179830329, 50.8676310365276],
                                 [23.908285462358208, 50.774990688033824], [24.061760697234263, 50.59891057360238],
                                 [23.953495221468984, 50.472799140293375], [23.717206353173367, 50.427889676526036],
                                 [23.346732664982255, 50.18488435858791], [22.8917797206675, 49.81630584878491],
                                 [22.58720871192122, 49.514352247144984], [22.694284457183585, 49.40489704087679],
                                 [22.676438499639858, 49.244283422983244], [22.599106016950373, 49.15743309627044],
                                 [22.305520186514343, 48.93110669693249], [22.05329731989633, 48.41714311967314],
                                 [22.36024778964844, 48.17205863607262], [22.50301544999826, 48.08639803986273],
                                 [22.764756160639593, 48.060223968798596], [22.878970288919447, 47.896041159396304],
                                 [23.074086091397533, 47.93649199649542], [23.190679680683218, 48.03880881974612],
                                 [23.497630150435327, 47.903179542413795], [23.723678945989207, 47.95552768454206],
                                 [24.013973188700504, 47.85559032229719], [24.53031622696568, 47.88890277637881],
                                 [24.960998669020967, 47.660474519819104], [25.394060572082083, 47.85321086129136],
                                 [26.191180009035236, 47.95790714554789], [26.40449069485112, 48.062745054722825],
                                 [26.733697118364546, 48.210130012165905], [27.00019675101754, 48.30530845239912],
                                 [27.486869751357517, 48.32899448603598], [27.603739041789595, 48.39111067352741],
                                 [27.966257919384645, 48.26247815429417], [28.131979385083923, 48.069883437740316],
                                 [28.26760866241625, 48.01277637360039], [28.396099556731087, 47.984222841530425],
                                 [28.527810716760598, 48.0054963656645], [28.646783767052113, 48.09115696187439],
                                 [28.843754693959227, 47.97177653510613], [28.910063133990434, 47.79148650005817],
                                 [29.151824365539596, 47.863918435817595], [29.03761023725974, 47.44989222080312],
                                 [29.254736054041757, 47.31009888671059], [29.459434372846772, 47.241637721841016],
                                 [29.525399743454955, 46.88774455817571], [29.849601305499334, 46.756874202855045],
                                 [29.796063432868152, 46.557594343616756], [29.608680878659015, 46.45349292461168],
                                 [29.332068536731242, 46.602209237476075], [28.88150960192047, 46.54940785501475],
                                 [28.917284900541063, 46.27397202412294], [28.82945211046831, 46.08222626561991],
                                 [28.737361916007274, 45.97962326530069], [28.738789592610885, 45.873975196641766],
                                 [28.67597182205691, 45.84256631136475], [28.550336280949125, 45.7997360132598],
                                 [28.457537301721743, 45.70693703403242], [28.48751851039532, 45.60557199518411],
                                 [28.44040518247988, 45.54703725444057], [28.29335449231945, 45.571307756700094],
                                 [28.169146627815223, 45.46708736464478], [28.371494576222403, 45.280986534439535],
                                 [28.674544145453467, 45.18297972054853], [28.896077475026686, 45.224912888169115],
                                 [29.211350548368728, 45.375716062020786], [29.495458192464923, 45.37857141522784],
                                 [29.693905240351057, 45.17013063111716], [29.77214191822293, 45.19582880998013],
                                 [29.842098071794226, 45.36001161938242], [30.18783369412131, 45.585726147653475],
                                 [30.742010224199305, 45.885444198689925], [31.66393527970382, 45.885796022259626],
                                 [32.16164424949778, 45.59153317524965], [32.413867116115796, 45.43924767087651],
                                 [32.428018302235955, 45.30239363377325], [32.53897917580241, 45.302952144462665],
                                 [32.865679110082624, 45.28258281551075], [33.01296780816381, 45.226809392276095],
                                 [33.48024636048876, 45.054227085523166], [33.49226263856815, 44.666077508947126],
                                 [33.30431804288963, 44.57452625954318], [33.475249492376406, 44.48000365829114],
                                 [33.61920688322914, 44.46275256599887], [33.63169905350975, 44.41099928912206],
                                 [33.701298287930285, 44.40861982811623], [33.73151744270439, 44.355676820736505],
                                 [33.85762887601339, 44.38125602654918], [33.97422246529908, 44.36222033850254],
                                 [34.14732825347323, 44.402076310350196], [34.1842098990636, 44.48238311929697],
                                 [34.26927563002204, 44.481193388794054], [34.3048386576383, 44.531191813179134],
                                 [34.35897139552094, 44.53000208267622], [34.37384302680738, 44.568073458769504],
                                 [34.472590658549336, 44.698348948838714], [34.649503584332706, 44.75848982576093],
                                 [34.73218985428531, 44.79775093235713], [34.92433133050611, 44.79834579760859],
                                 [34.95907146119134, 44.82333013816981], [35.02688609985751, 44.81381229414649],
                                 [35.03580907862937, 44.78109470531632], [35.13098751886258, 44.787043357830896],
                                 [35.17334192476636, 44.885790989572854], [35.263761442987914, 44.912559925888445],
                                 [35.27208955650832, 44.951821032484645], [35.37202691875319, 44.93040588343217],
                                 [35.3999855855717, 44.942303188461324], [35.38273449327943, 44.98215916030898],
                                 [35.44816967093976, 45.01011782712749], [35.41390543245569, 45.04807023017054],
                                 [35.487192831435436, 45.088996959470876], [35.564287368024225, 45.10327372550586],
                                 [35.71942822560442, 45.06234699620552], [35.83935306029832, 44.968120340374696]]]
            }
        )
        # Use generator expression to force all pages to be read
        features = list((result))
        print(f'Feature count: {len(features)}')
        image_ids = [feature.id for feature in features]
        with open('uk_image_ids_20230919.txt', 'w') as file:
            for image_id in image_ids:
                print(image_id, file=file)


def run():
    parser = argparse.ArgumentParser()
    parser.add_argument('--token', required=True)
    args = parser.parse_args()
    token = args.token

    examples = Examples(token)
    # print('Test search method')
    # examples.search_example()
    # print()
    print('Test query method')
    examples.query_example()


if __name__ == '__main__':
    run()
